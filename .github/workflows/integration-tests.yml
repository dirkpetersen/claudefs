name: Integration & Cross-Crate Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Full workspace integration tests
  integration-full:
    name: Full Workspace Integration
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo git
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}

      - name: Run integration tests
        run: cargo test --workspace --test '*' -- --test-threads=4
        timeout-minutes: 25

  # Transport layer tests
  transport-integration:
    name: Transport Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-transport-int-${{ hashFiles('**/Cargo.lock') }}

      - name: Run transport integration tests
        run: cargo test -p claudefs-tests transport_tests -- --test-threads=4

  # FUSE + Transport integration
  fuse-integration:
    name: FUSE Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-fuse-int-${{ hashFiles('**/Cargo.lock') }}

      - name: Run FUSE integration tests
        run: cargo test -p claudefs-tests fuse_tests -- --test-threads=4

  # Replication integration
  repl-integration:
    name: Replication Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-repl-int-${{ hashFiles('**/Cargo.lock') }}

      - name: Run replication integration tests
        run: cargo test -p claudefs-tests repl_integration -- --test-threads=4

  # Gateway integration
  gateway-integration:
    name: Gateway Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-gateway-int-${{ hashFiles('**/Cargo.lock') }}

      - name: Run gateway integration tests
        run: cargo test -p claudefs-tests gateway_integration -- --test-threads=4

  # Distributed/multi-node simulation tests
  distributed-tests:
    name: Distributed Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-distributed-${{ hashFiles('**/Cargo.lock') }}

      - name: Run distributed tests
        run: cargo test -p claudefs-tests distributed_tests -- --test-threads=2
        timeout-minutes: 25

  # Jepsen linearizability tests
  jepsen-tests:
    name: Jepsen Linearizability
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-jepsen-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Jepsen tests
        run: cargo test -p claudefs-tests jepsen -- --test-threads=2
        timeout-minutes: 20

  # Fault recovery and resilience
  fault-recovery:
    name: Fault Recovery Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-fault-${{ hashFiles('**/Cargo.lock') }}

      - name: Run fault recovery tests
        run: cargo test -p claudefs-tests fault_recovery -- --test-threads=2
        timeout-minutes: 20

  # Security integration
  security-integration:
    name: Security Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-sec-int-${{ hashFiles('**/Cargo.lock') }}

      - name: Run security integration tests
        run: cargo test -p claudefs-tests security_integration -- --test-threads=2

  # Quota and multi-tenancy
  quota-tests:
    name: Quota & Multi-Tenancy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-quota-${{ hashFiles('**/Cargo.lock') }}

      - name: Run quota tests
        run: cargo test -p claudefs-tests quota_integration -- --test-threads=2

  # Management API integration
  mgmt-integration:
    name: Management API Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-mgmt-int-${{ hashFiles('**/Cargo.lock') }}

      - name: Run management integration tests
        run: cargo test -p claudefs-tests mgmt_integration -- --test-threads=2

  # Performance regression baseline
  perf-regression:
    name: Performance Regression
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-perf-${{ hashFiles('**/Cargo.lock') }}

      - name: Run performance regression tests
        run: cargo test -p claudefs-tests perf_regression -- --test-threads=2
        timeout-minutes: 20
