name: All Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run nightly at 00:00 UTC
    - cron: '0 0 * * *'

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Run all unit tests across all crates
  all-tests:
    name: All Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo git
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run all tests
        run: cargo test --workspace --all-targets --lib
        timeout-minutes: 40

  # Per-crate detailed test runs
  storage-tests:
    name: Storage Engine Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-storage-${{ hashFiles('**/Cargo.lock') }}

      - name: Run storage tests
        run: cargo test -p claudefs-storage --lib -- --test-threads=4

  meta-tests:
    name: Metadata Service Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-meta-${{ hashFiles('**/Cargo.lock') }}

      - name: Run metadata tests
        run: cargo test -p claudefs-meta --lib -- --test-threads=4

  reduce-tests:
    name: Data Reduction Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-reduce-${{ hashFiles('**/Cargo.lock') }}

      - name: Run reduce tests
        run: cargo test -p claudefs-reduce --lib -- --test-threads=4

  transport-tests:
    name: Transport Layer Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-transport-${{ hashFiles('**/Cargo.lock') }}

      - name: Run transport tests
        run: cargo test -p claudefs-transport --lib -- --test-threads=4

  fuse-tests:
    name: FUSE Client Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-fuse-${{ hashFiles('**/Cargo.lock') }}

      - name: Run FUSE tests
        run: cargo test -p claudefs-fuse --lib -- --test-threads=4

  repl-tests:
    name: Replication Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-repl-${{ hashFiles('**/Cargo.lock') }}

      - name: Run replication tests
        run: cargo test -p claudefs-repl --lib -- --test-threads=4

  gateway-tests:
    name: Protocol Gateway Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-gateway-${{ hashFiles('**/Cargo.lock') }}

      - name: Run gateway tests
        run: cargo test -p claudefs-gateway --lib -- --test-threads=4

  mgmt-tests:
    name: Management Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-mgmt-${{ hashFiles('**/Cargo.lock') }}

      - name: Run management tests
        run: cargo test -p claudefs-mgmt --lib -- --test-threads=4

  security-tests:
    name: Security Audit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-security-${{ hashFiles('**/Cargo.lock') }}

      - name: Run security tests
        run: cargo test -p claudefs-security --lib -- --test-threads=2

  tests-harness:
    name: Validation Harness Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-tests-${{ hashFiles('**/Cargo.lock') }}

      - name: Run all claudefs-tests
        run: cargo test -p claudefs-tests --lib -- --test-threads=4
        timeout-minutes: 25
