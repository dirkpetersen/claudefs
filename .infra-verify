#!/usr/bin/env bash
# Infrastructure Verification Script for ClaudeFS
# Checks all bootstrap components are in place and functional

set -euo pipefail

echo "=== ClaudeFS Infrastructure Verification ==="
echo

CHECKS_PASSED=0
CHECKS_TOTAL=0

check_file() {
    local file=$1
    local description=$2
    CHECKS_TOTAL=$((CHECKS_TOTAL + 1))
    if [[ -f "$file" ]]; then
        echo "✓ $description ($file)"
        CHECKS_PASSED=$((CHECKS_PASSED + 1))
        return 0
    else
        echo "✗ $description ($file) — NOT FOUND"
        return 1
    fi
}

check_executable() {
    local cmd=$1
    local description=$2
    CHECKS_TOTAL=$((CHECKS_TOTAL + 1))
    if command -v "$cmd" &> /dev/null; then
        echo "✓ $description ($cmd)"
        CHECKS_PASSED=$((CHECKS_PASSED + 1))
        return 0
    else
        echo "✗ $description ($cmd) — NOT FOUND"
        return 1
    fi
}

check_dir() {
    local dir=$1
    local description=$2
    CHECKS_TOTAL=$((CHECKS_TOTAL + 1))
    if [[ -d "$dir" ]]; then
        echo "✓ $description ($dir)"
        CHECKS_PASSED=$((CHECKS_PASSED + 1))
        return 0
    else
        echo "✗ $description ($dir) — NOT FOUND"
        return 1
    fi
}

echo "Bootstrap Scripts:"
check_file "tools/cfs-dev" "Main CLI tool (cfs-dev)"
check_file "tools/orchestrator-user-data.sh" "Orchestrator bootstrap"
check_file "tools/storage-node-user-data.sh" "Storage node bootstrap"
check_file "tools/client-node-user-data.sh" "Client node bootstrap"
check_file "tools/cfs-agent-launcher.sh" "Agent launcher"
check_file "tools/cfs-cost-monitor.sh" "Cost monitor"
echo

echo "IAM Policies:"
check_file "tools/iam-policies/cfs-orchestrator-policy.json" "Orchestrator IAM policy"
check_file "tools/iam-policies/cfs-spot-node-policy.json" "Spot node IAM policy"
check_file "tools/iam-policies/ec2-trust-policy.json" "EC2 trust policy"
echo

echo "Cargo Workspace:"
check_file "Cargo.toml" "Workspace root Cargo.toml"
check_dir "crates/claudefs-storage" "Storage crate"
check_dir "crates/claudefs-meta" "Metadata crate"
check_dir "crates/claudefs-reduce" "Reduction crate"
check_dir "crates/claudefs-transport" "Transport crate"
check_dir "crates/claudefs-fuse" "FUSE crate"
check_dir "crates/claudefs-repl" "Replication crate"
check_dir "crates/claudefs-gateway" "Gateway crate"
check_dir "crates/claudefs-mgmt" "Management crate"
echo

echo "Development Tools:"
check_file "Makefile" "Development Makefile"
check_file "CHANGELOG.md" "Changelog"
check_file "CLAUDE.md" "Implementation guidance"
check_file "README.md" "Project README"
check_file "LICENSE" "MIT License"
echo

echo "Documentation:"
check_dir "docs" "Documentation directory"
check_file "docs/decisions.md" "Architecture decisions"
check_file "docs/agents.md" "Agent plan"
echo

echo "Built-in Tools:"
check_executable "cargo" "Rust toolchain"
check_executable "rustc" "Rust compiler"
check_executable "git" "Git"
check_executable "gh" "GitHub CLI"
check_executable "aws" "AWS CLI"
echo

echo "=== Verification Summary ==="
echo "Passed: $CHECKS_PASSED / $CHECKS_TOTAL"
if [[ $CHECKS_PASSED -eq $CHECKS_TOTAL ]]; then
    echo "✓ All infrastructure checks passed!"
    exit 0
else
    echo "✗ Some checks failed"
    exit 1
fi
